# 数字IC设计

note about IC Knowledge

## 基础知识

### 	建立/保持时间

### 	跨时钟域信号处理

#### （1）亚稳态的定义

触发器无法再某个规定时间段达到一个可确认的状态。一个触发器进入亚稳态，无法预测该单元的输出电平及何时输出才能稳定。

此期间会输出一些中间级电平，或者可能处于振荡状态，并且这种无用的输出电平会沿触发器级联传播。

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220110224123328.png" alt="image-20220110224123328" style="zoom:50%;" /><img src="D:\Typora\Markdown_file\数字IC_images\image-20220110224130460.png" alt="image-20220110224130460" style="zoom:50%;" />

#### （2）MTBF（平均失效间隔时间）

$$
MTBF=\frac{e^{t_{MET}}*C_2}{C_1*f_{clk}*f_{DATA}}
$$

Tmet：寄存器从时钟上升沿触发后的时序裕量时间（slack），fclk：接收时钟域的时钟频率，fDATA：数据的变化频率，C1、C2：与器件有关的参数
$$
t_{MET}=采样时钟周期时间-T_{co}-T_{data}-T_{setuptime}+(T_{clk2}-T_{clk1})
$$
在时钟频率fclk和数据变化率fDATA固定的情况下，为了缓解亚稳态：减小Tdata（数据到达下一级寄存器的输入端口的其他延时时间）

#### （3）同步电路与异步电路的比较

- 同步电路：电路中所有受时钟控制的单元，全部由一个统一的全局时钟控制

  - 优点

    - 同步设计中，EDA工具可以保证电路系统的时序收敛，有效避免电路设计中竞争冒险现象。
    - 在时钟边缘才改变取值，很大程度上减少了整个电路受毛刺和噪声影响的可能。

  - 缺点

    - Clock Skew（时钟偏斜）

    <img src="D:\Typora\Markdown_file\数字IC_images\image-20220110223538210.png" alt="image-20220110223538210" style="zoom: 33%;" />

    - Clock Jiter（时钟抖动）
    - 时钟树综合，需要加入大量的延迟单元，使得电路的面积和功耗大大增加。

- 异步电路：电路中没有一个全局的或局部的控制时钟，电路的数据传输可以在任何时候发生。

  - 优点
    - 模块化特性突出
    - 对信号延迟不敏感
    - 没有时钟偏斜问题
    - 潜在的高性能特性、电磁兼容性、低功耗特性。
  - 缺点
    - 设计复杂
    - 缺少EDA工具支持
    - 大规模IC设计应避免采用异步电路设计

#### （4）单bit信号的CDC

##### 一、慢时钟域到快时钟域

**1、双锁存器同步法**（电平检测）

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220110225135391.png" alt="image-20220110225135391" style="zoom:50%;" />

- 优点
  - 结构简单，易于实现
- 缺点
  - 增加了两级触发器延时
  - 快时钟-慢时钟时，易造成慢时钟采样丢失（还未采样数据就变化了）

- 适用条件
  - {(Clk_slow 的周期 )} > {(Clk_fast 的周期 ) + 路径延时 )} ，确保信号可以被Clk_fast 采样到（假设 Clk_fast 和 Clk_slow 起始时刻相同）
  - {(data 数据变化间隔 )} > {(Clk_slow 的周期 )+2*(Clk_fast 的周期 ) + 路径延时 )} ，确保所有的数据变化均能采集到、
- 使用几级DFF进行异步信号同步最合适？

​        两级触发器已经将MTBF变得足够大；三级或者更多级虽然能将亚稳态出现的概率降得很低，但影响电路效率。

**2、边沿检测同步器（慢时钟域到快时钟域）**（边沿检测）

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220110225937284.png" alt="image-20220110225937284" style="zoom:50%;" />

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220110230036030.png" alt="image-20220110230036030" style="zoom:50%;" />

##### 二、快时钟域到慢时钟域

信号从快时钟域到慢时钟域时，慢时钟将可能无法对变化太快的信号实现正确采样

###### 脉冲检测电路

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111082236846.png" alt="image-20220111082236846" style="zoom:50%;" />

从左至右电路为：快时钟域下的翻转电路+慢时钟域的两级同步器+慢时钟域一级触发器+一个逻辑门

- 适用条件：
  - 输入数据的宽度必须比一个接受时钟周期加上一个同步触发器的hold时间要长，最安全的就是两个同步周期宽度。
  - 慢时钟域的脉冲足够保持到快时钟域的同步器拿到
- 限制：
  - 输入脉冲直接的最小间隔必须等于两个同步器时钟周期
  - 如果输入脉冲相互过近，则新时钟域中的输出脉冲也紧密相邻，结果是输出脉冲宽度比一个时钟周期宽**（Nyquist 采样定理：对于具有最大频率 fMAX 的有限带宽信号，等间隔采样频率 fS 必须大于两倍的最大频率 fMAX，才能唯一地重建信号而不会有混叠现象。）**

上述同步器法对两个时钟之间的关系要求很严格，而“结绳法”适合任何时钟域的过渡。

###### 结绳法1

将快时钟域的脉冲周期延长，等慢时钟同步采样后再“解绳”， 还原为原来的脉冲周期宽度。

利用数据的边沿作时钟（图中上升沿）。（可以将脉冲无限延长，直到可以采集到数据，然后复位，要考虑产生数据的频率）

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111090057990.png" alt="image-20220111090057990" style="zoom: 50%;" />



- 数据作为Din_ClkA，当数据上升沿时，寄存器1的输出会稳定在高电平，等待ClkB采样，当ClkB完成采样后，寄存器4会输出高电平，若此时Din_ClkA为低电平，那么即可完成复位，开始下一次采样等待。
- 需要注意：CLKB域需要等待3个CLKB才会在寄存器4输出并完成输入端复位，所以Din_ClkA如果变化较快，即持续时间短于3个CLKB，也就是Din_ClkA频率大于ClkB的1/3，那么这时Din_ClkA的变化将无法被采样到，因为CLKB域需要3个CLKB才能完成采样，并且此时Din_CLKA必须是低电平才能复位（异步复位）
- 结绳法适合采样数据较少（脉冲间隔较大）的控制信号，脉冲间隔Ta>3Tb。

###### 结绳法2

利用数据作为异步复位

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111090850955.png" alt="image-20220111090850955" style="zoom:50%;" />

- 结绳法可以解决快时钟域到慢时钟域的过渡问题，且其适用范围很广。
- 结绳法实现较为复杂，效率不高，对设计性能要求较高的场合应该慎用。

如何传递两个同时需要的信号？例如b_load和b_en。

多个控制信号跨时钟域仅仅通过简单的同步器同步有可能是不安全的。例如遇到小的skew，会导致在a_clk时钟域中两个信号并不是同一时刻起作用，与在b_clk中的逻辑关系不同。可以通过（1）合并成一个信号传输。（2）译码信号通过加入另一个控制信号传输

#### （5）握手协议进行同步的原理和代码

**结绳法3：**握手协议也可作为结绳法，用于慢时钟域采样快时钟域的信号传输。

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111090943745.png" alt="image-20220111090943745" style="zoom:50%;" />

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111091013374.png" alt="image-20220111091013374" style="zoom:50%;" />

**慢到快：只需要考虑亚稳态问题**

**快到慢：除亚稳态还需要考虑采样速率问题，因为根据采样定理，采样频率低于信号最高频率2倍的时候，是无法完整采样的。**

握手协议同步与两级DFF同步器的比较：

- 握手协议面积更大，功耗更小，性能更优。
- 握手协议适用于快时钟域到慢时钟域的传输，两级DFF适用于慢时钟域到快时钟域的传输。

#### （6）多bit信号CDC-异步FIFO的原理和代码

同步策略--FIFO（first in first out），是一种先进先出的储存结构。

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111152922940.png" alt="image-20220111152922940" style="zoom:50%;" />

- 与普通存储器的区别：没有外部读写地址线，使用简单
- 缺点：只能顺序写入/读出数据，不能像普通存储器那样由地址线决定读取或写入某个指定的地址。
- 多时钟情况下，数据在不同时钟域直接传输很容易引起亚稳态；异步FIFO就是一种简单、快捷的解决方案。

- 使用情况：
  - 异步FIFO读写分别用于相互异步的不同时钟
  - 对于不同宽度的数据接口也可以用FIFO
- FIFO常见参数
  - FIFO宽度
  - FIFO深度
  - 空/满标志
  - 读/写时钟

**异步FIFO电路图：**

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111160638676.png" alt="image-20220111160638676" style="zoom:50%;" />

关键点

- 空满状态的判断：
  - 读写指针相等，表明FIFO为空，发生在复位操作或者当读指针读出FIFO中最后一个字后，追赶上了写指针。
  - 当读写指针再次相等时，表明FIFO为满，这种情况发生在当写指针转了一圈，折回（wrapped around）又追上了读指针
  - 如何区分满状态还是空状态见Q3。
  - 异步FIFO空满状态判断采用格雷码。见Q2。

- 亚稳态的消除，见Q5





**Q1：为什么需要同步读写指针**

**Q2：为什么要用格雷码？**

格雷码相邻2个数值只会有一次变化，是一种循环码（数值数量为2的整数次幂时），仅1位翻转引起亚稳态的概率远小于几位同时翻转的概率，很好抑制亚稳态出现的概率。

格雷码深度要保证为2的整数次幂。非2的整数次幂情况下不再使用，解决方法有：

- 深度为偶数，采用最接近的2次幂的格雷码编码，在此基础上修改。（浪费存储空间，简化控制电路复杂度）
- 深度为一般数值，自行设计一种逻辑电路，或者查找表，实现指针每次只跳变一次的功能。（较为复杂）

**异步FIFO工作在不同的时钟域，不用格雷码，假如从0111-1000转变时，得到的值可能为0000-1111中的任意一个。**

格雷码转换二进制：从左边第二位起，将每位与左边一位解码后的值异或（XOR），作为解码后的值，最左边一位不变。

![image-20220111155138791](D:\Typora\Markdown_file\数字IC_images\image-20220111155138791.png)

二进制转换格雷码：从最右边第一位开始，依次将每一位与左邻一位异或（XOR），最左边一位不变。

![image-20220111155205323](D:\Typora\Markdown_file\数字IC_images\image-20220111155205323.png)

格雷码判断为空需要同时满足3条：

- wptr和同步过来的rptr的MSB不相等，因为wptr必须比rptr多折回一次
- wptr与rptr的次高位不相等，如下图的位置7和15，转换二进制对应的是0111和1111，MSB不同说明多折回一次，111相同代表同一位置。
- 剩余其余位完全相等

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111160450663.png" alt="image-20220111160450663" style="zoom: 50%;" />



**Q3：满空状态如何判断**

在地址中添加一个额外的位MSB，读/写指针增加并越过最后一个FIFO的地址时，就将MSB+1，其它位置回0。（如对于深度为8的FIFO，需要采用4bit的计数器，0000-1000，1001-1111，MSB作为折回标志，低3位作为地址指针）

- 如果两个指针的MSB不同，说明多折回一次，为满。
- 如果两个指针的MSB相同，说明折回次数相等，为空。

**Q4：为什么会有假满假空现象以及会对系统产生什么影响**

1、格雷码同步出错导致假满假空。

在相邻两次跳变直接，格雷码同步出错时，000->001，000->000，地址没有跳变，但是用这个错误的写地址去做空判断不会出错，最多是让空标志在不是真正空的时候产生，不会出现读空。

即使出错，但也能保证FIFO功能的正确性。

超过两个周期时，格雷码可能多位数据跳变，因此地址总线bus skew一定不能超过一个周期。

2、格雷码同步时本就产生的假满假空。

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111162620791.png" alt="image-20220111162620791" style="zoom:50%;" />

读写时钟频率相近时，同步后的读指针一定小于或等于当前读地址，所以此时判断FIFO为满不一定是真满，为保守判断的假满。

3、对系统的影响

不会影响系统共功能，存在冗余空间。

**Q5：两拍同步与多拍同步的差异**

地址总线打两拍为了避免亚稳态传播，但因为时钟异步，亚稳态不可避免，只是可以极大降低亚稳态传播的概率。

多拍可以将亚稳态出现概率进一步降低。但影响电路工作速度。

低频时：STA不需要分析这里的异步时序，因为寄存器可以一拍内消除亚稳态。

高频时：不一定，在28nm工艺一下，需要检查两级触发器的延迟，保证延迟低，提高MTBF。

**Q6：FIFO深度如何选择**

假设FIFO写时钟100MHZ，读时钟80MHZ，在FIFO输入侧，每100个写时钟写入80个数据；读数据侧，假定每个时钟读走一个数据。FIFO深度设置多少不会上溢和下溢？

需要判断负载最大情况：

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111160804045.png" alt="image-20220111160804045" style="zoom: 33%;" />

背靠背传输下：
$$
160*（\frac{1}{100}）us内写入160个数据，读出160*\frac{80}{100}个数据
$$

$$
depth=burst-data_{numread}=32
$$
通用公式（假设读数据时没Y个时钟周期可以读X个数据）：
$$
depth=burst_{length}-\frac{burst_{length}}{wclk}*(rclk*\frac{X}{Y})
$$

#### （7）异步/同步复位以及异步复位同步释放

##### 一、同步复位电路：

复位信号发生变化，并不立即生效，等待有效时钟沿采样后才复位。

```verilog
always@(posedge clk)
    if(!rst)
        .....
```

- 优点
  - 有利于仿真器仿真
  - 可以使设计的系统成为同步时序电路，有利于时序分析，综合出来fmax较高
  - 滤除高于时钟频率的毛刺
- 缺点
  - 复位信号有效时长需大于时钟周期，同时需要考虑clk skew，组合逻辑延时，复位延时等
  - 需在输入端口插入组合逻辑耗费资源较多（因为大多库中DFF只有异步复位端口）

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111165222434.png" alt="image-20220111165222434" style="zoom:50%;" />

##### 二、异步复位电路

无论时钟沿是否有效，复位信号到达直接复位。

```verilog
always@(posedge clk or negedge rst_n)
    if(!rst_n)
        .....
```

- 优点
  - 节省资源
  - 设计简单
  - 识别方便， 可以使用FPGA全局复位端口GSR
- 缺点
  - 复位信号释放在时钟沿附近，容易输出亚稳态
  - 复位信号易受毛刺影响。

##### 三、异步复位同步释放

为了避免释放造成的亚稳态问题，复位信号可以不受影响直接复位，并且复位信号取消时跟时钟信号同步。

<img src="D:\Typora\Markdown_file\数字IC_images\image-20220111165602129.png" alt="image-20220111165602129" style="zoom:67%;" /><img src="D:\Typora\Markdown_file\数字IC_images\image-20220111165700366.png" alt="image-20220111165700366" style="zoom:67%;" />

- 优点
  - 快速复位
  - 短脉宽复位也不会丢失
  - 复位撤离是同步的，有良好的撤离时序和足够的恢复时间

注意：复位网络通常会布线在全局网络，布线时需要控制各个路径的时钟偏移保持在大致相等的水平上，使复位可以同步撤离。



### 	综合与时序分析

DC做综合或者用PT做时序分析

1）ASIC设计流程，从spec到GDSII的全过程，以及每一步的意义和工具；

2）综合的概念，以及主要操作步骤；

3）综合的常用脚本，包括创建原时钟、分频时钟，设置时钟参数等等；

4）Setup time和Hold time的概念；

5）静态时序分析（STA）的概念和优缺点；

6）用PT做STA所需要的数据和脚本，以及弄懂PT时序分析报告上的信息；

7）时钟抖动（jitter）和时钟偏移（skew）的概念，以及他们对时序分析的影响（更严格还是更宽松了？）；

8）对一个“输入-DFF-组合逻辑-DFF-输出”的一个典型系统进行时序分析，计算该系统的最大运行频率（最小周期）；

9）如何修复Setup违例和Hold违例；

### 低功耗方法

1）集成电路中功耗的来源；

2）动态功耗与哪些参数有关，开关功耗的公式，以及静态功耗与哪些参数有关；

3）SoC系统中常用的低功耗技术，从体系结构级到器件工艺级都要能列出一种，比如划分不同电压域、时钟域，使用不同阈值的器件等等；

4）RTL级的低功耗设计方法，重点是门控时钟，包括基于与门和基于锁存器的门控时钟结构的代码和优缺点比较；

### 计算机组成与设计

这部分的内容稍微有点偏向专用领域，但是平头哥和比特大陆等公司的笔试题里出现了不少相关内容。

1）计算机中使用补码的意义；

2）超前进位加法器的原理和代码；

3）小数定点化的概念，包括对于一个确定的十进制小数，需要多少bit才能无损定点化；

4）基于IEEE-754标准的浮点数的表示；

5）计算机中的乘法和除法如何计算的（只需知道最简单的方法）；

6）流水线设计的作用和优缺点；

7）处理器中结构冒险、数据冒险、控制冒险的概念和解决机制；

8）cache的映射方法和写回策略有哪些；



## Coding

### HDLBits

### 基本电路单元

### 常见编程题

1）奇数分频电路的代码，包括两种情况：使用带负沿触发的DFF（要求占空比50%），不使用带负沿触发的DFF；

2）按键去抖动电路的代码；

3）无毛刺时钟切换电路的代码；

4）用状态机实现的序列检测电路，比如“1011”检测；



## AMBA片上总线

- 数据传输靠主设备（Master）发起
- 主设备（Master）靠地址线表明需要访问的从设备（Slave）
- 互联总线（Bus-Arbiter/Bus-Matrix/Bus-NOC）靠地址线路由访问（command/data），并最终选中目标从设备（Slave）
- Master/Bus-Bus/Slave之间要有流量控制，防止数据丢失。

### APB（Advanced Peripheral Bus）总线

- APB主要用在低速且低功率消耗的IP接口上，协议简单，时钟clock也比较低，通常用作AHB/AXI总线的扩展。
- 不需要仲裁器
- 必须在时钟上升沿触发
- 主要构成是：
  - APB Bridge：可以锁存所有的地址、数据和控制信号，并译码产生APB Slave的SEL信号。
  - APB Slave，即总线上的全部Slave设备。

### AHB



### AXI

AMBA AXI协议支持支持高性能、高频率系统设计。

- 适合高带宽低延时设计
- 无需复杂的桥就能实现高频操作
- 能满足大部分器件的接口要求
- 适合高初始延时的存储控制器
- 提供互联架构的灵活性与独立性
- 向下兼容已有的AHB和APB接口

关键特点：

- 分离的地址/控制、数据相位
- 使用字节线来支持非对齐的数据传输
- 使用基于burst的传输，只需传输首地址
- 分离的读、写数据通道，能提供低功耗DMA
- 支持多种寻址方式
- 支持乱序传输
- 允许容易的添加寄存器级来进行时序收敛

### AXI总线架构

AXI协议是基于burst的传输，并且定义了以下5个独立的传输通道：读地址通道、读数据通道；写地址通道、写数据通道、写响应通道。

地址通道携带控制消息用于描述被传输的数据属性，数据传输使用写通道来实现“主”到“从”的传输，“从”使用写响应通道来完成一次写传输；读通道用来实现数据从“从”到“主”的传输。

- 读/写地址通道：读、写传输每个都有自己的地址通道，对应的地址通道承载着对应传输的地址控制信息。
- 读数据通道：读数据通道承载着读数据和读响应信号包括数据总线（8/16/32/64/128/256/512/1024bit）和指示读传输完成的读响应信号。
- 写数据通道：写数据通道的数据信息被认为是缓冲（buffered）了的，“主”无需等待“从”对上次写传输的确认即可发起一次新的写传输。写通道包括数据总线（8/16...1024bit）和字节线（用于指示8bit 数据信号的有效性）。
- 写响应通道：“从”使用写响应通道对写传输进行响应。所有的写传输需要写响应通道的完成信号。
- 

## RISC-V处理器 做出基本功能





## 面试问题

你的职业规划是什么：脚踏实地 目光长远

你还有什么问题吗：只问公司部门IC相关业务，规模，进展。

为将来的工作做什么准备。

## SoC外围设计

### 	外设设计

### 	总线协议

#### 		GPIO

#### 		SPI

#### 		UART

#### 		I2C

## 处理器设计

### 指令集并行

#### 	预取

#### 	分支预测

#### 	数据冒险与旁路前传

#### 	乱序执行与动态调度

#### 	推测

### 数据集并行

#### 	GPGPU

#### 	RV-V SPEC

### 线程级并行

#### 	多线程技术

#### 	多核技术

## AI芯片设计

### 时域

#### 	GPGPU

### 空域

#### 	数据复用

#### 	映射方法

#### 	存储优化

### 模型压缩



推荐书籍

1、《Xilinx FPGA数字信号处理系统设计指南 从HDL Simulink到HLS的实现》
2、《Verilog编程艺术》
3、《计算机体系结构量化研究方法》
3.5、《计算机体系结构》
4、《ARM体系结构与编程》
5、《SoC设计方法与实现》
6、《手把手教你设计CPU——RISC-V处理器》
6.5、《RISC-V CPU工程与实践》
7、《CPU设计实战》
8、《无为是一种境界》心态境界提升

## FPGA

### FPGA器件内部结构

#### 1、LUT（Look up table）查找表

LUT6中INIT存放的结果初始值就是逻辑表达式真值表结果。LUT6本质是深度64位宽1的ROM

```verilog
 //以下是例1网表中的LUT6
  LUT6 #(
    .INIT(64'h8000000000000000)) 
    dout_OBUF_inst_i_1
       (.I0(data5_IBUF),
        .I1(data0_IBUF),
        .I2(data2_IBUF),
        .I3(data1_IBUF),
        .I4(data4_IBUF),
        .I5(data3_IBUF),
        .O(dout_OBUF)); 
 
 
//以下是例2网表中的LUT6
LUT6 #(
    .INIT(64'h78FFFFFFFF787878)) 
    dout_OBUF_inst_i_1
       (.I0(data0_IBUF),
        .I1(data1_IBUF),
        .I2(data2_IBUF),
        .I3(data3_IBUF),
        .I4(data4_IBUF),
        .I5(data5_IBUF),
        .O(dout_OBUF));
```

<img src="D:\Typora\Markdown_file\数字IC知识整理_images\image-20220121143722029.png" alt="image-20220121143722029" style="zoom:80%;" />

只比较高8位，与LUT6中INIT值相同，修改INIT值将门电路一一映射。

**只要逻辑表达式是6位以内输入1位输出，无论编译后门电路复杂还是简单，综合后的结果都是一个LUT6**，相比于各种门，提高器件利用率。

XILINX的LUT6除了可以做到6位输入1位输出，还可以做到5位相同的输入2位输出，因为LUT6是由两个LUT5组成的。

#### 2、DRAM

DRAM（[Distributed](https://so.csdn.net/so/search?q=Distributed&spm=1001.2101.3001.7020) RAM，翻译为分布式随机存储器，而不是我们平时看到的动态随机存储器）

### FPGA常用的IP以及高速接口的应用

### FPGA时序

# 数字IC验证

SystemVerilog

UVM

